require "mockups"
sds021 = require "sds021-lib"


local testData1 = string.char(0xAA,0xC0,0x73,0x00,0x9E,0x00,0xA9,0xEA,0xA4,0xAB)
local testData2 = string.char(0xAA,0xC0,0x64,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB)

local function assertEquals(message, v, t)
	if(v==t) then
		print(message.." - OK ")
		return
	end
	print(message.." - FAIL expected:"..v.." got:"..t)
end

local function doTest(testData, _PM25, _PM10)
	sds021.resetValues()
	PM25, PM10, meanPM25, meanPM10 = sds021.readData(testData)
	assertEquals("PM25", _PM25, PM25)
	assertEquals("PM10", _PM10, PM10)
	assertEquals("meanPM25", 0, meanPM25)
	assertEquals("meanPM10", 0, meanPM10)
end

doTest(testData1, 11.5, 15.8)
doTest(testData2, 10.0, 10.6)
doTest(string.char(
	0xAA,0xC0,0x64,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB,
	0xAA,0xC0,0x64,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB)
	, 10.0, 10.6)

doTest(string.char(
	0xC0,0x64,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB,
	0xAA,0xC0,0x64,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB, 0xAA)
	, 10.0, 10.6)

-- corrupt head
doTest(string.char(
	0xAA,0xAA,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB,
	0xAA,0xC0,0x64,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB, 0xAA)
	, 10.0, 10.6)
doTest(string.char(
	0xAA,0xAA,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB,
	0xAA,0xC0,0x64,0x00,0x6A,0x00,0xAB,0xA6,0x1F,0xAB)
	, 10.0, 10.6)
